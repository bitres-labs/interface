name: E2E (Synpress)

on:
  workflow_dispatch:
  # Temporarily disabled - E2E tests need fixing
  # push:
  #   branches: [main]
  # pull_request:

jobs:
  synpress-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      CI: true
    steps:
      - name: Checkout interface
        uses: actions/checkout@v4
        with:
          path: interface

      - name: Checkout contracts
        uses: actions/checkout@v4
        with:
          repository: bitres-labs/bitres
          path: bitres
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: |
            interface/package-lock.json
            bitres/package-lock.json

      - name: Install interface dependencies
        working-directory: interface
        run: npm ci

      - name: Install Playwright browsers
        working-directory: interface
        run: |
          # Install browsers for project's Playwright version (1.57.0)
          npx playwright install --with-deps chromium

          # Install browsers for Synpress's internal Playwright version (1.48.2)
          # This creates chromium-1140 in ~/.cache/ms-playwright/ which synpress-cache expects
          npx -y -p playwright@1.48.2 -- playwright install --with-deps chromium

          # Verify the browser directories exist
          ls -la ~/.cache/ms-playwright/ || true

      - name: Install contracts dependencies
        working-directory: bitres
        if: false
        run: npm install --legacy-peer-deps

      - name: Start Hardhat and deploy contracts
        working-directory: bitres
        if: false
        run: |
          set -e
          # Start Hardhat node in background
          npx hardhat node --hostname 0.0.0.0 > /tmp/hardhat.log 2>&1 &
          HARDHAT_PID=$!
          echo "Started Hardhat node (PID: $HARDHAT_PID)"

          # Wait for node to be ready
          echo "Waiting for Hardhat node..."
          for i in {1..60}; do
            if nc -z 127.0.0.1 8545 2>/dev/null; then
              echo "Hardhat node ready"
              break
            fi
            sleep 1
          done

          # Verify node is running
          if ! nc -z 127.0.0.1 8545 2>/dev/null; then
            echo "Hardhat node failed to start"
            tail -50 /tmp/hardhat.log
            exit 1
          fi

          # Deploy contracts
          echo "Deploying contracts..."
          rm -rf ignition/deployments/chain-31337
          echo "y" | npx hardhat ignition deploy ignition/modules/FullSystem.ts --network localhost 2>&1 | tee /tmp/ignition-deploy.log

          # Initialize system
          echo "Initializing system..."
          npx hardhat run scripts/main/init-full-system.mjs --network localhost 2>&1 | tee /tmp/init-full-system.log

          echo "Contracts deployed and initialized"

      - name: Generate frontend config
        if: false
        run: |
          DEPLOYMENT_DIR="bitres/ignition/deployments/chain-31337"
          if [ -d "$DEPLOYMENT_DIR" ]; then
            echo "Deployment artifacts found"
            mkdir -p interface/src/config
            cp "$DEPLOYMENT_DIR/deployed_addresses.json" interface/src/config/contracts.json 2>/dev/null || echo "No deployed_addresses.json"
          fi

      - name: Diagnose MetaMask extension load
        working-directory: interface
        run: |
          set -e
          npx -y -p playwright@1.40.0 playwright install chromium
          OLD_CHROMIUM=$(npx -y -p playwright@1.40.0 node -e "const { chromium } = require('playwright-core'); console.log(chromium.executablePath())")
          export DIAG_CHROMIUM_EXECUTABLE_PATH="$OLD_CHROMIUM"
          echo "Using Playwright 1.40.0 chromium: $DIAG_CHROMIUM_EXECUTABLE_PATH"
          "$DIAG_CHROMIUM_EXECUTABLE_PATH" --version || true
          xvfb-run -a node e2e/diagnose-extension.cjs

      - name: Dump logs on failure
        if: failure()
        run: |
          echo "==== /tmp/hardhat.log (tail) ===="
          tail -200 /tmp/hardhat.log || true
          echo "==== /tmp/ignition-deploy.log (tail) ===="
          tail -200 /tmp/ignition-deploy.log || true
          echo "==== /tmp/init-full-system.log (tail) ===="
          tail -200 /tmp/init-full-system.log || true
          echo "==== /tmp/ignition-deploy-e2e.log (tail) ===="
          tail -200 /tmp/ignition-deploy-e2e.log || true
          echo "==== /tmp/init-full-system-e2e.log (tail) ===="
          tail -200 /tmp/init-full-system-e2e.log || true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results
          path: |
            interface/test-results/
            interface/playwright-report/
            /tmp/hardhat.log
            /tmp/ignition-deploy.log
            /tmp/init-full-system.log
            /tmp/ignition-deploy-e2e.log
            /tmp/init-full-system-e2e.log
          retention-days: 7
